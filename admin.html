<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmpTier — Admin</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<header class="header container">
  <img src="assets/logo.png" alt="logo" class="logo">
  <div class="brand-section">
    <div class="brand">SmpTier</div>
    <div class="lead">Panneau Administrateur</div>
  </div>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="criteres.html">Critères</a>
    <a href="classement.html">Classement</a>
    <a href="file-test.html">Tester mon SMP</a>
    <a href="admin.html">Admin</a>
  </nav>
</header>

<main>
  <section class="section card">
    <h2>Connexion Admin</h2>
    <input type="password" id="adminPass" placeholder="Mot de passe">
    <button class="btn btn-primary" id="loginBtn">Se connecter</button>

    <div id="adminContent" style="display:none; margin-top:20px;">
      <h3>File d'attente des SMP</h3>
      <div id="queueList"></div>

      <h3>Tierlist complète</h3>
      <div id="tierList"></div>
    </div>
  </section>
</main>

<script type="module">
import { db } from './firebase-init.js';
import { collection, getDocs, addDoc, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const password = "LesGoatsSmpTier"; // change le mot de passe ici
const loginBtn = document.getElementById('loginBtn');
const adminPass = document.getElementById('adminPass');
const adminContent = document.getElementById('adminContent');
const queueList = document.getElementById('queueList');
const tierListDiv = document.getElementById('tierList');

loginBtn.addEventListener('click', async ()=>{
  if(adminPass.value !== password){
    alert('Mot de passe incorrect');
    return;
  }
  adminContent.style.display='block';
  loadQueue();
  loadTierList();
});

// ====== FILE D'ATTENTE ======
async function loadQueue(){
  queueList.innerHTML = '<p>Chargement…</p>';
  try{
    const snap = await getDocs(collection(db,'smp_queue'));
    queueList.innerHTML = '';
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const div = document.createElement('div');
      div.className='queue-item';
      div.style.background='rgba(255,255,255,0.05)';
      div.style.padding='10px';
      div.style.margin='10px 0';
      div.style.borderRadius='8px';
      div.innerHTML = `
        <b>${d.name}</b> - ${d.discord} - ${d.ip}
        <button class="btn btn-secondary" data-id="${docSnap.id}" data-action="validate">Valider</button>
      `;
      queueList.appendChild(div);
    });

    // boutons valider
    queueList.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.dataset.id;
        const docRef = doc(db,'smp_queue',id);
        const snapDoc = await getDocs(collection(db,'smp_queue'));
        const docData = snapDoc.docs.find(doc=>doc.id===id)?.data();
        if(!docData) return alert('SMP introuvable');

        // Ajouter au classement public
        await addDoc(collection(db,'smp_public'),{
          name: docData.name,
          ip: docData.ip,
          discord: docData.discord,
          twist: docData.twist || "à remplir",
          tier: 5,
          date: new Date().toLocaleDateString(),
          timestamp: serverTimestamp()
        });

        // Supprimer de la file
        await deleteDoc(docRef);
        alert(`${docData.name} ajouté au classement`);
        loadQueue();
        loadTierList();
      });
    });

  }catch(err){
    console.error(err);
    queueList.innerHTML='<p>Erreur de chargement</p>';
  }
}

// ====== TIERLIST ======
async function loadTierList(){
  tierListDiv.innerHTML = '<p>Chargement…</p>';
  try{
    const snap = await getDocs(collection(db,'smp_public'));
    tierListDiv.innerHTML = '';
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const div = document.createElement('div');
      div.className='tier-item';
      div.style.background='rgba(255,255,255,0.05)';
      div.style.padding='10px';
      div.style.margin='10px 0';
      div.style.borderRadius='8px';
      div.innerHTML = `
        <b>${d.name}</b> - ${d.discord} - ${d.ip} - Tier: ${d.tier} - Twist: ${d.twist} - Date: ${d.date}
        <button class="btn btn-secondary" data-id="${docSnap.id}" data-action="edit">Modifier</button>
        <button class="btn btn-danger" data-id="${docSnap.id}" data-action="delete">Supprimer</button>
      `;
      tierListDiv.appendChild(div);
    });

    tierListDiv.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        const docRef = doc(db,'smp_public',id);

        if(action==='delete'){
          if(confirm('Supprimer ce SMP ?')){
            await deleteDoc(docRef);
            alert('SMP supprimé');
            loadTierList();
          }
        } else if(action==='edit'){
          const newTier = prompt('Nouveau Tier (1-5) :', '5');
          const newTwist = prompt('Twist :', '');
          const newDate = prompt('Date de création :', new Date().toLocaleDateString());
          await updateDoc(docRef,{
            tier: parseInt(newTier),
            twist: newTwist,
            date: newDate
          });
          alert('SMP modifié');
          loadTierList();
        }
      });
    });

  }catch(err){
    console.error(err);
    tierListDiv.innerHTML='<p>Erreur de chargement</p>';
  }
}
</script>

<footer class="footer">
  © 2025 SmpTier
</footer>
</body>
</html>
